{% extends "admin/base_site.html" %}
{% load i18n admin_static %}

{% block content %}
<script>
</script>
<style>
    label { display: inline-block; width: 80px }
    input { width: 400px; }
</style>

<form method="post" enctype="multipart/form-data">
    {{ form.as_p }}
    <button type="submit">{% trans "Envoyer" %}</button>
    {% csrf_token %}
</form>
<script>

function installParse(f) {
    var p = $('<p>').append($('<label>').text('Aper√ßu:')).append($('<div>')).insertAfter(f.parent());
    var selects = [];
    $('[type=number]').each(function() {
        if (f.attr('name') === 'tours_csv' && !this.name.startsWith('tours_')) return;
        if (f.attr('name') !== 'tours_csv' && this.name.startsWith('tours_')) return;
        var s = $('<select>').attr('name', this.name);
        selects.push(s);
        $(this).replaceWith(s)
    });
    console.log(f, selects)
    function parse() {
        f.parse({
            config: {
                preview: 4,
                delimiter: $('[name=delimiter]').val(),
                complete: function(results) {
                    $('[name=delimiter]').val(results.meta.delimiter);
                    p.find('div').html('<table>' + results.data.map(function(r) {
                        return '<tr><td>' + r.join('</td><td>') + '</td></tr>';
                    }).join('') + '</table>');

                    selects.forEach(function(s) {
                        s.empty();
                        s.append($('<option>'));
                        results.data[0].forEach(function(c, i) {
                            s.append($('<option>').val(i + 1).text('Colonne ' + (i + 1) + ' - ' + c));
                        });
                    });
                }
            }
        });
    };
    f.change(parse);
    parse();
}
installParse($('[name=csv]'));
installParse($('[name=tours_csv]'));

for (const k in ['time', 'tours_time', 'tours_timestamp']) {
    const temps_change = function () {
        var p = $(`[name=${k}_column]`).val() ? 'show' : 'hide';
        $(`[name=${k}_format]`).parent()[p]();
    };
    $(`[name=${k}_column]`).change(temps_change);
    temps_change();
}
</script>
{% endblock %}

